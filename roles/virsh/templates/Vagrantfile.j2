# -*- mode: ruby -*-
# vi: set ft=ruby :
require "yaml"

VAGRANT_API_VERSION             = "2"
ENV['VAGRANT_DEFAULT_PROVIDER'] = 'libvirt'
vagrant_dir         		= File.expand_path(File.dirname(__FILE__))
physical_iface_name 		= '__ext_iface__'
nodes 		    		= YAML.load( File.open(File.join( vagrant_dir, "vagrant.yml"), File::RDONLY).read )

Vagrant.configure(VAGRANT_API_VERSION) do |config|
  nodes.each do |node|
    config.disksize.size = node['disksize'].to_s
    config.vm.define node['hostname'] do |nodeconfig|
      nodeconfig.vm.box      = node['box_name']
      nodeconfig.vm.hostname = node['hostname']
      # Configure Network 
      nodeconfig.vm.network :forwarded_port, guest: 22, host: 2000, id: 'ssh'
      nodeconfig.vm.network 'private_network', ip: node['ip'].to_s
      
      # Provider config
      node_ram = node['ram']
      node_cpu = node['cpu']
      nodeconfig.vm.provider 'virtualbox' do |vb|
        libvirt.nested   = true
	libvirt.memory   = memory.to_s
	libvirt.cpus     = cpus.to_s
	libvirt.cpu_mode = 'host-model'
      end
      config.ssh.shell = "bash -c 'BASH_ENV=/etc/profile exec bash'"
      config.vm.provision :shell, :path => "bootstrap-ubuntu.sh"
    end
  end
end
