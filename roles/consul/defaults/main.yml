#--------------------- Consul ------------------#
config_dir: "{{ consul_config_dir | default(compose_dir) }}"
data_dir: "{{ consul_data_dir | default('/consul/data') }}"
replica: "{{ consul_replica | default('global') }}"
version: "{{ consul_version | default('1.2.4') }}"
stack_name: "{{ consul_stack_name | default('consul') }}"

consul_datacenter: "default"
consul_api_token: "SECR3T"
consul_log_level: "INFO"
consul_docker_vol: "{{ stack_name }}"

images:
  - name: "consul"
    prefix: "consul"
    tag: "{{ version }}"
    ports: 8500:8500
    environment:
      - CONSUL_ALLOW_PRIVILEGED_PORTS="53"
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_HTTP_TOKEN={{ consul_api_token }}
    volumes:
      - "{{ consul_docker_vol }}:/consul/data"
      - "{{ config_dir }}/config.json:/consul/config.json"
    command: "agent -ui -config-file /consul/config.json -data-dir /consul/data -serf-lan-bind=0.0.0.0 -bootstrap-expect={{ groups['swarm-managers']|length }} -retry-join consul.cluster"

  - name: "registrator"
    prefix: "gliderlabs/registrator"
    tag: "master"
    environment:
      - "CONSUL_HTTP_TOKEN={{ consul_api_token }}"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock
    command:
      - "-internal consul://consul.cluster:8500"
